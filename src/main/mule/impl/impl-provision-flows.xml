<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:java="http://www.mulesoft.org/schema/mule/java"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd">
	<sub-flow name="impl-post-provision-subflow"
		doc:id="1fdbc7bd-7ea6-43b4-8d4b-b6ad2ccb4aac">
		<logger level="INFO"
			doc:name="START - Process Provision Request"
			doc:id="e4c0b6d0-080f-4f86-a704-fe912ca9ab34"
			message="START - Process Provision Request " />
		<java:invoke-static doc:name="vars.hmacTimeStamp"
			doc:id="4d7a5934-875b-40d3-a73e-6e3fe5944d66"
			class="com.facebookTimestamp.utils.TimestampUtils"
			method="generateHmacTimestamp()" target="hmacTimeStamp" />
		<ee:transform doc:name="Payload to Facebook Request" doc:id="8299711e-a255-45f5-8589-fca4acf7ddf6" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
import dw::Crypto
output application/json

var dt = payload
var timestamp = vars.hmacTimeStamp
var carrierId = p('facebook.carrier.id')
var secretKey = p('facebook.secret.key')
var concatData = timestamp ++ carrierId
var hmacValue = Crypto::HMACWith(secretKey as Binary, concatData as Binary, "HmacSHA256")

---
{
  requestPayload: {
    msisdn: dt.msisdn,
    timestamp: timestamp,
    provision: {
      fb_product_id: dt.provision.'fb-product-id',
      expiration: dt.provision.expiration
    }
  },
  requestParams: {
    data_type: "provision",
    timestamp: timestamp,
    carrier_id: carrierId,
    hmac: hmacValue
  }
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref
			doc:name="facebook-provision-flow"
			doc:id="f1255e39-e0c6-4cde-81dc-1660ee567ca5"
			name="facebook-provision-flow" />
		<logger level="INFO" doc:name="END - Process Provision Request"
			doc:id="d030a6c4-e526-490c-91aa-478998ad2726"
			message="END - Process Provision Request " />
	</sub-flow>


</mule>
