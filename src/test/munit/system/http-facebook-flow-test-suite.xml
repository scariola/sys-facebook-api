<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracing="http://www.mulesoft.org/schema/mule/tracing"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
http://www.mulesoft.org/schema/mule/tracing http://www.mulesoft.org/schema/mule/tracing/current/mule-tracing.xsd">
	<munit:config name="http-facebook-flow-test-suite.xml" />
	<munit:test name="post-carrier-phone-status-flow-success-test" doc:id="cc23124a-673c-4a53-9e29-c8f233d6d77d">
		<munit:behavior >
			<munit-tools:mock-when doc:name="Mock POST/carrier-phone-status" doc:id="3dfa74e3-93ba-4ca7-8c69-ca34036f1cbe" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value="#[output application/json --- readUrl('classpath://dw/mocks/payload-facebook-success.dwl')]" mediaType="application/json" encoding="UTF-8" />
					<munit-tools:attributes value="#[output application/json --- readUrl('classpath://dw/mocks/attr-headers.dwl')]" mediaType="application/json" encoding="UTF-8" />
					<munit-tools:variables >
						<munit-tools:variable key="hmac" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmac.dwl')]" mediaType="application/json" encoding="UTF-8" />
						<munit-tools:variable key="originalPayload" value="#[output application/json --- readUrl('classpath://dw/mocks/var-originalPayload.dwl')]" mediaType="application/json" encoding="UTF-8" />
						<munit-tools:variable key="requestParams" value="#[output application/json --- readUrl('classpath://dw/mocks/var-requestParams.dwl')]" mediaType="application/java" encoding="UTF-8" />
						<munit-tools:variable key="hmacTimeStamp" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmacTimeStamp.dwl')]" mediaType="application/java" encoding="UTF-8" />
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Input" doc:id="5d483e5a-51ea-4b37-9661-a52666d91a89">
				<munit:payload value="#[output application/json --- readUrl('classpath://dw/events/post-provision-request.dwl')]" encoding="UTF-8" mediaType="application/json" />
				<munit:attributes value="#[output application/json --- readUrl('classpath://dw/events/attr-post-provision.dwl')]" />
				<munit:variables >
					<munit:variable key="hmac" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmac.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="originalPayload" value="#[output application/json --- readUrl('classpath://dw/mocks/var-originalPayload.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="requestParams" value="#[output application/json --- readUrl('classpath://dw/mocks/var-requestParams.dwl')]" encoding="UTF-8" mediaType="application/java" />
					<munit:variable key="hmacTimeStamp" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmacTimeStamp.dwl')]" encoding="UTF-8" mediaType="application/java" />
				</munit:variables>
			</munit:set-event>
			<tracing:with-correlation-id doc:name="With CorrelationID" doc:id="7c3f1996-6930-4d9c-84ea-4663ce34f8f1" correlationId='#["123"]'>
				<flow-ref doc:name="Flow-ref to http-facebook-post-carrier-phone-status-flow" doc:id="b2306377-d4b6-4cfd-a219-801002b10d58" name="post-carrier-phone-status-flow" />
			</tracing:with-correlation-id>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert doc:name="Assert payload" doc:id="14a5068a-6e24-45ec-a282-1aa7d5867f58" message="The payload does not match">
				<munit-tools:that ><![CDATA[#[%dw 2.0
import * from dw::test::Asserts
---
payload must equalTo({
  "x-event-id": "123",	
  "x-event-code": 1005,
  "x-event-msg": "Provisioning successful"
})]]]></munit-tools:that>
			</munit-tools:assert>
			<munit-tools:assert doc:name="Assert attributes" doc:id="0b9a08a6-e7f7-4064-8602-a3eb5f9276d9" message="The attributes do not match">
				<munit-tools:that ><![CDATA[#[%dw 2.0
import * from dw::test::Asserts
---
attributes must [
  beObject(),
  $[*"statusCode"] must haveSize(1),
  $[*"statusCode"][0] must equalTo(200)
]]]]></munit-tools:that>
			</munit-tools:assert>
			<munit-tools:verify-call doc:name="Verify END- POST/carrier-phone-status" doc:id="ab73cb87-d91c-47b0-bd7e-03e960d27f78" processor="logger" times="1">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="ef1b2c43-2601-40e9-ae40-b172b17d623e" attributeName="doc:id" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>
	<munit:test name="post-carrier-phone-status-flow-unsuccessful-fb-error-test" doc:id="7764e629-ae06-483c-931c-21a4fdcf5d8d">
		<munit:behavior>
			<munit-tools:mock-when doc:name="Mock POST/carrier-phone-status" doc:id="28e8a1f4-3769-4ff6-a874-3d54cc521982" processor="http:request" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value="#[output application/json --- readUrl('classpath://dw/mocks/payload-facebook-not-success.dwl')]" mediaType="application/json" encoding="UTF-8" />
					<munit-tools:attributes value="#[output application/json --- readUrl('classpath://dw/mocks/attr-headers.dwl')]" mediaType="application/json" encoding="UTF-8" />
					<munit-tools:variables >
						<munit-tools:variable key="hmac" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmac.dwl')]" mediaType="application/json" encoding="UTF-8" />
						<munit-tools:variable key="originalPayload" value="#[output application/json --- readUrl('classpath://dw/mocks/var-originalPayload.dwl')]" mediaType="application/json" encoding="UTF-8" />
						<munit-tools:variable key="requestParams" value="#[output application/json --- readUrl('classpath://dw/mocks/var-requestParams.dwl')]" mediaType="application/java" encoding="UTF-8" />
						<munit-tools:variable key="hmacTimeStamp" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmacTimeStamp.dwl')]" mediaType="application/java" encoding="UTF-8" />
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution>
			<munit:set-event doc:name="Set Input" doc:id="dcecbe42-741f-4e9f-83f7-838bea9ac8b6" >
				<munit:payload value="#[output application/json --- readUrl('classpath://dw/events/post-provision-request.dwl')]" encoding="UTF-8" mediaType="application/json" />
				<munit:attributes value="#[output application/json --- readUrl('classpath://dw/events/attr-post-provision.dwl')]" />
				<munit:variables >
					<munit:variable key="hmac" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmac.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="originalPayload" value="#[output application/json --- readUrl('classpath://dw/mocks/var-originalPayload.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="requestParams" value="#[output application/json --- readUrl('classpath://dw/mocks/var-requestParams.dwl')]" encoding="UTF-8" mediaType="application/java" />
					<munit:variable key="hmacTimeStamp" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmacTimeStamp.dwl')]" encoding="UTF-8" mediaType="application/java" />
				</munit:variables>
			</munit:set-event>
			<try doc:name="Try" doc:id="6169af83-572b-4d78-ac08-8ca4de8c7be7">
				<flow-ref doc:name="Flow-ref to http-facebook-post-carrier-phone-status-flow" doc:id="abe855fb-9957-4079-8365-049e8d275db3" name="post-carrier-phone-status-flow" />
				<error-handler>
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="a7ced592-91cc-4a7f-8b99-7a9d69ca20b6">
						<logger level="INFO" doc:name="Logger" doc:id="b4b25764-5809-4eff-8d65-a9172156f9c9" message="Facebook Provision Unsuccessful" />
					</on-error-continue>
				</error-handler>
			</try>
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-that doc:name="Asset Payload Msg" doc:id="30774386-b382-447a-9ffe-cb05e9d4ac3a" is="#[MunitTools::equalTo('Provision Unsuccessful.')]" expression="#[payload.'x-event-msg']" />
			<munit-tools:assert-that doc:name="Asset Error Type" doc:id="0a1accd6-d9b4-4d06-a3a6-c599b31959ec" is="#[MunitTools::equalTo('FACEBOOK:ERROR')]" expression="#[payload.result.'error-type']" />
			<munit-tools:verify-call doc:name="Verify POST/carrier-phone-status" doc:id="b0f3faf5-1133-4eb5-b71c-acf1990a173a" processor="http:request" times="1">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>
	<munit:test name="post-carrier-phone-status-flow-api_Shared_Error_Handler-http-bad-request-test" doc:id="491e1332-0740-4b52-a5e5-29ce6422653e">
		<munit:behavior >
			<munit-tools:mock-when doc:name="Mock POST/carrier-phone-status" doc:id="005b6792-e02e-405c-80c3-d9b078843a92" processor="http:request" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:error typeId="HTTP:BAD_REQUEST" />
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Input" doc:id="da9705fc-8c2a-4c16-8a12-76c64c02393f" >
				<munit:payload value="#[output application/json --- readUrl('classpath://dw/events/post-provision-request.dwl')]" encoding="UTF-8" mediaType="application/json" />
				<munit:attributes value="#[output application/json --- readUrl('classpath://dw/events/attr-post-provision.dwl')]" />
				<munit:variables >
					<munit:variable key="hmac" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmac.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="originalPayload" value="#[output application/json --- readUrl('classpath://dw/mocks/var-originalPayload.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="requestParams" value="#[output application/json --- readUrl('classpath://dw/mocks/var-requestParams.dwl')]" encoding="UTF-8" mediaType="application/java" />
					<munit:variable key="hmacTimeStamp" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmacTimeStamp.dwl')]" encoding="UTF-8" mediaType="application/java" />
				</munit:variables>
			</munit:set-event>
			<try doc:name="Try" doc:id="b7544d11-4338-48d5-86f0-f0032616d6b9" >
				<flow-ref doc:name="Flow-ref to http-facebook-post-carrier-phone-status-flow" doc:id="24a433e3-cb78-46a8-b20c-7ddc66316e5f" name="post-carrier-phone-status-flow" />
				<error-handler >
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="08ed5b3c-af80-47cf-9128-e1786df8e2ab" >
						<logger level="INFO" doc:name="Logger" doc:id="0906c032-13bf-4a65-99ae-e389409fb018" message="Facebook Provision Unsuccessful" />
					</on-error-continue>
				</error-handler>
			</try>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-that doc:name="Asset Payload Msg" doc:id="dfc50feb-cb1a-4463-ba1b-aefaaf2619fe" is="#[MunitTools::equalTo('Bad Request - Invalid Parameter or Request')]" expression="#[payload.'x-event-msg']" />
			<munit-tools:assert-that doc:name="Asset Error Type" doc:id="a3f5b5a5-15a7-4bfd-a392-541c8576a903" expression="#[payload.result.'error-type']" is="#[MunitTools::equalTo('HTTP:BAD_REQUEST')]" />
			<munit-tools:verify-call doc:name="Verify POST/carrier-phone-status" doc:id="af0ac120-1bed-4aad-84c1-b4bf706a087f" processor="http:request" times="1" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>
	<munit:test name="post-carrier-phone-status-flow-api_Shared_Error_Handler-http-connectivity-test" doc:id="8538fbba-6c20-4bbc-b247-94a90d2fd1cf">
		<munit:behavior >
			<munit-tools:mock-when doc:name="Mock POST/carrier-phone-status" doc:id="965c9c0f-3978-4de5-8337-79dd756b5233" processor="http:request" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:error typeId="HTTP:CONNECTIVITY" />
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Input" doc:id="f10f1ed8-e8c6-4b4c-b00d-422167b64773" >
				<munit:payload value="#[output application/json --- readUrl('classpath://dw/events/post-provision-request.dwl')]" encoding="UTF-8" mediaType="application/json" />
				<munit:attributes value="#[output application/json --- readUrl('classpath://dw/events/attr-post-provision.dwl')]" />
				<munit:variables >
					<munit:variable key="hmac" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmac.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="originalPayload" value="#[output application/json --- readUrl('classpath://dw/mocks/var-originalPayload.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="requestParams" value="#[output application/json --- readUrl('classpath://dw/mocks/var-requestParams.dwl')]" encoding="UTF-8" mediaType="application/java" />
					<munit:variable key="hmacTimeStamp" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmacTimeStamp.dwl')]" encoding="UTF-8" mediaType="application/java" />
				</munit:variables>
			</munit:set-event>
			<try doc:name="Try" doc:id="6e702a66-1441-4e6a-9451-011046e32150" >
				<flow-ref doc:name="Flow-ref to http-facebook-post-carrier-phone-status-flow" doc:id="13ec0b65-8eda-43dc-b7d6-c4c04b268dff" name="post-carrier-phone-status-flow" />
				<error-handler >
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="5dbba01e-0129-40d7-978d-8c893ed2a991" >
						<logger level="INFO" doc:name="Logger" doc:id="db5a6d91-d46d-47e8-a6ce-86aace867e7d" message="Facebook Provision Unsuccessful" />
					</on-error-continue>
				</error-handler>
			</try>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-that doc:name="Asset Payload Msg" doc:id="de55e5e9-e050-4019-aab9-c11532171c74" expression="#[payload.'x-event-msg']" is="#[MunitTools::equalTo('Facebook API unreachable')]" />
			<munit-tools:assert-that doc:name="Asset Error Type" doc:id="821f9738-b7c1-4cfe-880c-22da50eaefdb" expression="#[payload.result.'error-type']" is="#[MunitTools::equalTo('HTTP:CONNECTIVITY')]" />
			<munit-tools:verify-call doc:name="Verify POST/carrier-phone-status" doc:id="da92a9c5-22a8-4193-867b-4b9448e0f4c3" processor="http:request" times="1" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>
	<munit:test name="post-carrier-phone-status-flow-api_Shared_Error_Handler-any-test" doc:id="7b6ee4b6-a189-4782-8f53-2c0f606ef23f">
		<munit:behavior >
			<munit-tools:mock-when doc:name="Mock POST/carrier-phone-status" doc:id="44dc7265-e852-4f05-9f88-6a6b31393a49" processor="http:request" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:error typeId="ANY" />
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Input" doc:id="d27ca51e-3052-499c-a2ce-21c5fcb5f7db" >
				<munit:payload value="#[output application/json --- readUrl('classpath://dw/events/post-provision-request.dwl')]" encoding="UTF-8" mediaType="application/json" />
				<munit:attributes value="#[output application/json --- readUrl('classpath://dw/events/attr-post-provision.dwl')]" />
				<munit:variables >
					<munit:variable key="hmac" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmac.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="originalPayload" value="#[output application/json --- readUrl('classpath://dw/mocks/var-originalPayload.dwl')]" encoding="UTF-8" mediaType="application/json" />
					<munit:variable key="requestParams" value="#[output application/json --- readUrl('classpath://dw/mocks/var-requestParams.dwl')]" encoding="UTF-8" mediaType="application/java" />
					<munit:variable key="hmacTimeStamp" value="#[output application/json --- readUrl('classpath://dw/mocks/var-hmacTimeStamp.dwl')]" encoding="UTF-8" mediaType="application/java" />
				</munit:variables>
			</munit:set-event>
			<try doc:name="Try" doc:id="9115c5e3-6044-45a8-8003-c4961658278e" >
				<flow-ref doc:name="Flow-ref to http-facebook-post-carrier-phone-status-flow" doc:id="0379f528-146c-479d-af25-71a6d053b664" name="post-carrier-phone-status-flow" />
				<error-handler >
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="fde2d03c-35fb-4a19-a69f-d11c229e47db" >
						<logger level="INFO" doc:name="Logger" doc:id="17e19184-0bb1-4d2e-9d2c-d71a77def9fe" message="Facebook Provision Unsuccessful" />
					</on-error-continue>
				</error-handler>
			</try>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-that doc:name="Asset Payload Msg" doc:id="028a7a70-9f64-4b85-8e93-fb9724c1b693" expression="#[payload.'x-event-msg']" is="#[MunitTools::equalTo('Unexpected system error')]" />
			<munit-tools:assert-that doc:name="Asset Error Type" doc:id="62497b4d-20f3-4ea0-b0a1-71931326c0af" expression="#[payload.result.'error-type']" is="#[MunitTools::equalTo('MULE:ANY')]" />
			<munit-tools:verify-call doc:name="Verify POST/carrier-phone-status" doc:id="c47a16f2-093c-403c-a494-18279dbfc21a" processor="http:request" times="1" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="e0bb2b4c-136e-4554-87e1-f53a76ab2ce3" attributeName="doc:id" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>


</mule>
